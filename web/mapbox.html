<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Zone Builder demo</title>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
	<link href="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.css" rel="stylesheet">
	<script src="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.js"></script>
	<style>
		body {
			margin: 0px;
			border: 0px;
			padding: 0px;
		}

		#map {
			height: 80%;
			width: 80%;
			position: absolute;
		}
	</style>
</head>

<body>
	<h1><a href="https://zonebuilders.github.io/zonebuilder/articles/paper.html" target="_blank">ClockBoard zone
			generator</a></h1>
	<span id="num_circles_value"></span> Circles: <input type="range" min="1" max="10" value="5" id="num_circles"
		oninput="window.regenerate();">
	<span id="num_segments_value"></span> Segments: <input type="range" min="1" max="23" value="12" id="num_segments"
		oninput="window.regenerate();">
	<button type="button" onclick="window.download();">Download GeoJSON</button><br />
	<div id="map"></div>
	<script type="module">
		import init, { generate_triangular_sequence, make_clockboard } from "./pkg/zonebuilder.js";

		async function setup() {
			// Initialize the WASM function.
			await init();

			// TODO I feel like I probably just copied this from an example somewhere
			mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';

			// Create the Mapbox map
			const map = new mapboxgl.Map({
				container: 'map',
				style: 'mapbox://styles/mapbox/streets-v11',
				center: [-97.74, 30.27],
				zoom: 13
			});

			/*
			// Add an optional raster layer for population
			var worldpop = L.tileLayer('https://ogc.worldpop.org/geoserver/gwc/service/tms/1.0.0/wpGlobal%3Appp_2020@EPSG%3A900913@png/{z}/{x}/{-y}.png', {
				tms: true,
				opacity: 0.5,
				maxNativeZoom: 11
			});
			L.control.layers(null, { "<a href='https://www.worldpop.org' target='_blank' title='Only available when zoomed out'>WorldPop 2020</a>": worldpop }, { collapsed: false }).addTo(map);*/

			// Create a draggable marker representing the clockboard's center.
			// TODO Equivalent of autopan?
			// TODO Do we need to put all of this in map onload?
			const marker = new mapboxgl.Marker({
				draggable: true
			})
				.setLngLat([-97.7436995, 30.2711286])
				.addTo(map);
			marker.on('drag', regenerate);

			// When you click on the map, re-center the marker there.
			map.on('click', (e) => {
				marker.setLngLat(e.lngLat);
				regenerate();
			});

			/*// Add a search bar
			new GeoSearch.GeoSearchControl({
				provider: new GeoSearch.OpenStreetMapProvider(),
				showMarker: false,
				autoClose: true
			}).addTo(map);
			map.on('geosearch/showlocation', searchFinished);
			function searchFinished(ev) {
				// Note the order of coordinates
				marker.setLatLng([ev.location.y, ev.location.x]);
			}*/

			map.on('load', () => {
				// Create an empty GeoJSON layer
				map.addSource('clockboard', {
					'type': 'geojson',
					'data': {}
				});
				map.addLayer({
					'id': 'zones',
					'type': 'fill',
					'source': 'clockboard',
					'paint': {
						'fill-color': '#0080ff',
						'fill-opacity': 0.1
					}
				});
				map.addLayer({
					'id': 'outline',
					'type': 'line',
					'source': 'clockboard',
					'paint': {
						'line-color': '#0080ff',
						'line-width': 3
					}
				});
				map.addLayer({
					'id': 'labels',
					'type': 'symbol',
					'source': 'clockboard',
					'layout': {
						'text-field': ['get', 'label'],
						'text-size': 24
					},
					'paint': {
						'text-halo-color': 'white',
						'text-halo-width': 5
					}
				});

				// Create the initial clockboard.
				regenerate();
			});

			function regenerate() {
				var num_segments = parseInt(document.getElementById('num_segments').value);
				var num_circles = parseInt(document.getElementById('num_circles').value);
				var distances = generate_triangular_sequence(num_circles);
				var rawJson = JSON.parse(make_clockboard(marker.getLngLat().lat, marker.getLngLat().lng, distances, num_segments));
				map.getSource('clockboard').setData(rawJson);

				// Also update sliders
				document.getElementById('num_circles_value').innerHTML = num_circles;
				document.getElementById('num_segments_value').innerHTML = num_segments;
			}

			function download() {
				var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(map.getSource('clockboard').toGeoJSON()));
				var node = document.createElement('a');
				node.setAttribute("href", dataStr);
				node.setAttribute("download", 'clockboard.geojson');
				document.body.appendChild(node);
				node.click();
				node.remove();
			}

			// To call regenerate() in the onclick handler, we have to make the function visible.
			// According to https://stackoverflow.com/questions/53630310/use-functions-defined-in-es6-module-directly-in-html,
			// this is how you do it.
			window.regenerate = regenerate;
			window.download = download;
		}

		setup();
	</script>
</body>

</html>